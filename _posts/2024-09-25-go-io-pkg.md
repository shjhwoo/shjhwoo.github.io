---
title: "io package"
excerpt: "표준 라이브러리의 기반이 되는 가장 기본적인 패키지"

categories:
  - Blog
tags:
  - Golang
last_modified_at: 2024-09-25T08:06:00-05:00
---

# io

표준 라이브러리의 기반이 되는 가장 기본적인 패키지

바이트 스트림을 다루기 위한 인터페이스를 제공함

## 바이트로 할 수 있는 것: 읽기와 쓰기

### Reader interface

```jsx
type Reader interface {
        Read(p []byte) (n int, err error)
}
```

- 네트워크 연결
- 파일시스템
- 인메모리 슬라이스 wrapper

작동원리: 버퍼 역할을 하는 p를 매개변수로 전달한다.

⇒ 그래서 같은 바이트 p를 재사용할 수 있다.

만약에 버퍼를 리턴값으로 줬다면,

매번 새로운 바이트 슬라이스를 할당해야 하기 때문에 가비지 콜렉터에 무리를 줄 수 있음.

스트림이 끝나면 io.EOF 에러를 반환한다.

버퍼가 항상 채워지리라는 보장이 없다. ⇒ 버퍼 크기가 8바이트면, 들어오는 데이터의 크기는 0~8바이트 사이가 된다. (이를 해결해주는 함수들도 있다.)

reader 인터페이스 구현체가 읽히면, 다시 읽어서 데이터를 꺼내올 수 없음에 유의한다(\*)

(http req body를 두번 읽을 수 없음)

- [ ] 읽기 정확성을 좀 더 확실하게 보장하려면… io.ReadFull()

```jsx
type Reader interface {
        Read(p []byte) (n int, err error)
}
```

읽어들여야 하는 데이터의 크기를 미리 알고 있는 상황이라면 io.ReadFull을 사용.

즉, 버퍼가 빈틈없이 가득 찼음을 보장한다.

그렇지 않은 경우에는 ErrUnexpectedEOF, 읽은 데이터가 없으면 EOF를 리턴함

```go
buf := make([]byte, 8)
if _, err := io.ReadFull(r, buf); err == io.EOF {
        return io.ErrUnexpectedEOF
} else if err != nil {
        return err
}
```

- [ ] 여러 개의 소스로부터 데이터를 모아 하나로 병합 원할 경우엔 io.MultiReader()

```go
r := io.MultiReader(
        bytes.NewReader([]byte("...my header...")),
        myFile,
)
http.Post("http://example.com", "application/octet-stream", r)
```

- [ ] reader 내부의 consumer는 방해하지 않으면서 내부의 data를 캡처하여 다시 읽을 수 있도록 하는 io.TeeReader

```go
var buf bytes.Buffer
body := io.TeeReader(req.Body, &buf)
// ... process body ...
if err != nil {
        // inspect buf
        return err
}
```

⇒ 단, 메모리 낭비하지 않도록 유의한다.

실제 확인해봄:

```go
package main

import (
	"bytes"
	"fmt"
	"io"

	"github.com/gin-gonic/gin"
)

func main() {
	r := gin.Default()

	r.POST("/", handlePost)

	r.Run(":8080")
}

func handlePost(c *gin.Context) {
	var buffer bytes.Buffer
	requestBody1 := io.TeeReader(c.Request.Body, &buffer)

	var content = make([]byte, 2048)
	_, err := requestBody1.Read(content)

	fmt.Println(string(content))
	fmt.Println(err)

	_, err = requestBody1.Read(content)

	fmt.Println(string(content), "한번 더 읽었을 때 내용")
	fmt.Println(err, "한번 더 읽었을 때 에러")
}

-----
[GIN-debug] POST   /                         --> main.handlePost (3 handlers)
[GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value.
Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details.
[GIN-debug] Listening and serving HTTP on :8080
{
    "name":"joe",
    "age":2324,
    "blog":"shjhwoo.github.io"
}
EOF
{
    "name":"joe",
    "age":2324,
    "blog":"shjhwoo.github.io"
} 한번 더 읽었을 때 내용
EOF 한번 더 읽었을 때 에러
```

### Writer interface
